{% extends 'base.html' %}

{% block title %}{{ 'إعدادات الذكاء الاصطناعي' if current_locale == 'ar' else 'AI Settings' }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="bi bi-robot"></i>
                {{ 'إعدادات الذكاء الاصطناعي' if current_locale == 'ar' else 'AI Settings' }}
            </h2>
            <p class="text-muted mb-0">
                {{ 'تكوين Gemini API للتحليل التلقائي' if current_locale == 'ar' else 'Configure Gemini API for auto-analysis' }}
            </p>
        </div>
        <a href="{{ url_for('admin.settings') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-{{ 'left' if current_locale == 'ar' else 'left' }}"></i>
            {{ 'رجوع' if current_locale == 'ar' else 'Back' }}
        </a>
    </div>

    <div class="row">
        <!-- Settings Form -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-key"></i>
                        {{ 'إعدادات Gemini API' if current_locale == 'ar' else 'Gemini API Settings' }}
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin.update_ai_settings') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- API Key -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-key-fill text-warning"></i>
                                {{ 'مفتاح API' if current_locale == 'ar' else 'API Key' }}
                            </label>
                            <div class="input-group">
                                <input type="password"
                                       class="form-control"
                                       id="gemini_api_key"
                                       name="gemini_api_key"
                                       value="{{ masked_key }}"
                                       placeholder="{{ 'أدخل مفتاح Gemini API' if current_locale == 'ar' else 'Enter Gemini API Key' }}">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                {{ 'احصل على مفتاح API من' if current_locale == 'ar' else 'Get your API key from' }}
                                <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
                            </small>
                            {% if masked_key %}
                            <div class="mt-2">
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i>
                                    {{ 'مفتاح API مُعد' if current_locale == 'ar' else 'API Key configured' }}
                                </span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Model Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-cpu text-info"></i>
                                {{ 'النموذج' if current_locale == 'ar' else 'Model' }}
                            </label>
                            <select class="form-select" name="gemini_model" id="gemini_model">
                                <option value="gemini-2.5-flash" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-2.5-flash' }}>
                                    Gemini 2.5 Flash ({{ 'سريع - موصى به' if current_locale == 'ar' else 'Fast - Recommended' }})
                                </option>
                                <option value="gemini-3-flash-preview" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-3-flash-preview' }}>
                                    Gemini 3 Flash ({{ 'معاينة - الأحدث' if current_locale == 'ar' else 'Preview - Latest' }})
                                </option>
                                <option value="gemini-3-pro-preview" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-3-pro-preview' }}>
                                    Gemini 3 Pro ({{ 'معاينة - الأقوى' if current_locale == 'ar' else 'Preview - Most Powerful' }})
                                </option>
                                <option value="gemini-2.5-pro" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-2.5-pro' }}>
                                    Gemini 2.5 Pro ({{ 'أكثر دقة' if current_locale == 'ar' else 'More accurate' }})
                                </option>
                                <option value="gemini-2.5-flash-lite" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-2.5-flash-lite' }}>
                                    Gemini 2.5 Flash-Lite ({{ 'اقتصادي' if current_locale == 'ar' else 'Cost-effective' }})
                                </option>
                                <option value="gemini-2.0-flash" {{ 'selected' if ai_settings.get('gemini_model') == 'gemini-2.0-flash' }}>
                                    Gemini 2.0 Flash ({{ 'قديم' if current_locale == 'ar' else 'Legacy' }})
                                </option>
                            </select>
                        </div>

                        <!-- Enable/Disable -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enabled" name="enabled"
                                       {{ 'checked' if ai_settings.get('enabled', True) }}>
                                <label class="form-check-label fw-bold" for="enabled">
                                    <i class="bi bi-power text-success"></i>
                                    {{ 'تفعيل الذكاء الاصطناعي' if current_locale == 'ar' else 'Enable AI Features' }}
                                </label>
                            </div>
                            <small class="text-muted">
                                {{ 'إيقاف هذا سيعطل جميع ميزات التحليل التلقائي' if current_locale == 'ar' else 'Disabling this will turn off all auto-analysis features' }}
                            </small>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i>
                                {{ 'حفظ الإعدادات' if current_locale == 'ar' else 'Save Settings' }}
                            </button>
                            <button type="button" class="btn btn-outline-success" id="testConnection">
                                <i class="bi bi-wifi"></i>
                                {{ 'اختبار الاتصال' if current_locale == 'ar' else 'Test Connection' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle"></i>
                        {{ 'معلومات' if current_locale == 'ar' else 'Information' }}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small">
                        {{ 'يستخدم الذكاء الاصطناعي لـ:' if current_locale == 'ar' else 'AI is used for:' }}
                    </p>
                    <ul class="small mb-0">
                        <li>{{ 'تحليل النتائج الكيميائية تلقائياً' if current_locale == 'ar' else 'Auto-analyze chemical results' }}</li>
                        <li>{{ 'توليد السبب والملاحظات' if current_locale == 'ar' else 'Generate reason and notes' }}</li>
                        <li>{{ 'ملخص لوحة التحكم اليومي' if current_locale == 'ar' else 'Daily dashboard summary' }}</li>
                        <li>{{ 'تحليل التقارير' if current_locale == 'ar' else 'Report analysis' }}</li>
                    </ul>
                </div>
            </div>

            <!-- Test Result -->
            <div class="card border-0 shadow-sm" id="testResultCard" style="display: none;">
                <div class="card-header" id="testResultHeader">
                    <h6 class="mb-0">
                        <i class="bi bi-check-circle"></i>
                        {{ 'نتيجة الاختبار' if current_locale == 'ar' else 'Test Result' }}
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-0" id="testResultMessage"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle password visibility
document.getElementById('togglePassword').addEventListener('click', function() {
    const input = document.getElementById('gemini_api_key');
    const icon = this.querySelector('i');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
});

// Test connection
document.getElementById('testConnection').addEventListener('click', async function() {
    const btn = this;
    const resultCard = document.getElementById('testResultCard');
    const resultHeader = document.getElementById('testResultHeader');
    const resultMessage = document.getElementById('testResultMessage');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> {{ "جاري الاختبار..." if current_locale == "ar" else "Testing..." }}';

    try {
        const response = await fetch('{{ url_for("admin.test_ai_connection") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        resultCard.style.display = 'block';

        if (data.success) {
            resultHeader.className = 'card-header bg-success text-white';
            resultMessage.innerHTML = '<i class="bi bi-check-circle text-success"></i> ' + data.message;
        } else {
            resultHeader.className = 'card-header bg-danger text-white';
            resultMessage.innerHTML = '<i class="bi bi-x-circle text-danger"></i> ' + data.message;
        }
    } catch (error) {
        resultCard.style.display = 'block';
        resultHeader.className = 'card-header bg-danger text-white';
        resultMessage.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Connection error: ' + error.message;
    }

    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-wifi"></i> {{ "اختبار الاتصال" if current_locale == "ar" else "Test Connection" }}';
});

// Clear masked key when user starts typing
document.getElementById('gemini_api_key').addEventListener('focus', function() {
    if (this.value.startsWith('*')) {
        this.value = '';
    }
});
</script>
{% endblock %}
