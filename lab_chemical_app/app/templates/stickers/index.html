{% extends 'base.html' %}

{% block title %}Sticker Printing{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="bi bi-qr-code"></i>
                {{ 'طباعة الملصقات' if session.get('lang') == 'ar' else 'Sticker Printing' }}
            </h2>
            <p class="text-muted">
                {{ 'إنشاء وطباعة ملصقات الأنابيب مع QR Code' if session.get('lang') == 'ar' else 'Generate and print pipe stickers with QR codes' }}
            </p>
        </div>
    </div>

    <div class="row">
        <!-- Search Section -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-search"></i>
                        {{ 'البحث عن أنبوب' if session.get('lang') == 'ar' else 'Search Pipe' }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">{{ 'كود الأنبوب أو معرف المغرفة' if session.get('lang') == 'ar' else 'Pipe Code or Ladle ID' }}</label>
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control"
                                   placeholder="N8739 or 4713012025...">
                            <button type="button" class="btn btn-primary" onclick="searchPipes()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        <!-- Results will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sticker Size Selection -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-aspect-ratio"></i>
                        {{ 'حجم الملصق' if session.get('lang') == 'ar' else 'Sticker Size' }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group-vertical w-100" role="group">
                        <input type="radio" class="btn-check" name="stickerSize" id="sizeSmall" value="small">
                        <label class="btn btn-outline-success" for="sizeSmall">
                            <i class="bi bi-square"></i>
                            Small (80x50mm) - {{ 'صغير' if session.get('lang') == 'ar' else 'Compact' }}
                        </label>

                        <input type="radio" class="btn-check" name="stickerSize" id="sizeMedium" value="medium">
                        <label class="btn btn-outline-success" for="sizeMedium">
                            <i class="bi bi-square-fill"></i>
                            Medium (100x60mm) - {{ 'متوسط' if session.get('lang') == 'ar' else 'Standard' }}
                        </label>

                        <input type="radio" class="btn-check" name="stickerSize" id="sizeLarge" value="large">
                        <label class="btn btn-outline-success" for="sizeLarge">
                            <i class="bi bi-square-half"></i>
                            Large (120x80mm) - {{ 'كبير' if session.get('lang') == 'ar' else 'Detailed' }}
                        </label>

                        <input type="radio" class="btn-check" name="stickerSize" id="sizeGCP" value="gcp" checked>
                        <label class="btn btn-outline-success" for="sizeGCP">
                            <i class="bi bi-award"></i>
                            GCP Pro (140x90mm) - {{ 'احترافي' if session.get('lang') == 'ar' else 'Professional' }}
                        </label>

                        <input type="radio" class="btn-check" name="stickerSize" id="sizeCustom" value="custom">
                        <label class="btn btn-outline-success" for="sizeCustom">
                            <i class="bi bi-pencil-square"></i>
                            {{ 'مخصص' if session.get('lang') == 'ar' else 'Custom Size' }}
                        </label>
                    </div>

                    <!-- Custom Size Inputs -->
                    <div id="customSizeInputs" class="row g-2 mt-2" style="display: none;">
                        <div class="col-6">
                            <label class="form-label small">{{ 'العرض (مم)' if session.get('lang') == 'ar' else 'Width (mm)' }}</label>
                            <input type="number" id="customWidth" class="form-control" value="140" min="50" max="200">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">{{ 'الطول (مم)' if session.get('lang') == 'ar' else 'Height (mm)' }}</label>
                            <input type="number" id="customHeight" class="form-control" value="90" min="40" max="150">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-eye"></i>
                        {{ 'معاينة الملصق' if session.get('lang') == 'ar' else 'Sticker Preview' }}
                    </h5>
                    <div id="previewActions" style="display: none;">
                        <button type="button" class="btn btn-light btn-sm" onclick="downloadSticker()">
                            <i class="bi bi-download"></i>
                            {{ 'تحميل' if session.get('lang') == 'ar' else 'Download' }}
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="printSticker()">
                            <i class="bi bi-printer"></i>
                            {{ 'طباعة' if session.get('lang') == 'ar' else 'Print' }}
                        </button>
                    </div>
                </div>
                <div class="card-body text-center" style="min-height: 450px;">
                    <div id="previewPlaceholder">
                        <div class="py-5">
                            <i class="bi bi-qr-code text-muted" style="font-size: 100px;"></i>
                            <h5 class="text-muted mt-3">
                                {{ 'ابحث عن أنبوب لمعاينة الملصق' if session.get('lang') == 'ar' else 'Search for a pipe to preview sticker' }}
                            </h5>
                            <p class="text-muted small">
                                {{ 'الملصق يتضمن: كود المنتج، وصف المنتج، أمر البيع، رقم الأنبوب، كود الأنبوب، العميل، أمر الإنتاج' if session.get('lang') == 'ar' else 'Sticker includes: Product Code, Description, Sales Order, Pipe No., Pipe Code, Customer, Production Order' }}
                            </p>
                        </div>
                    </div>
                    <div id="previewContainer" style="display: none;">
                        <div class="bg-light p-3 rounded mb-3">
                            <img id="stickerPreview" src="" alt="Sticker Preview" class="img-fluid border shadow-lg" style="max-height: 350px;">
                        </div>
                        <div id="pipeInfo" class="text-start border-top pt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedPipeId = null;

// Show/hide custom size inputs
document.querySelectorAll('input[name="stickerSize"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const customInputs = document.getElementById('customSizeInputs');
        customInputs.style.display = this.value === 'custom' ? 'flex' : 'none';
        if (selectedPipeId) updatePreview();
    });
});

document.getElementById('customWidth').addEventListener('change', updatePreview);
document.getElementById('customHeight').addEventListener('change', updatePreview);

// Search on Enter
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchPipes();
});

function searchPipes() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;

    fetch(`/stickers/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';

            if (data.pipes.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No pipes found</div>';
                return;
            }

            data.pipes.forEach(pipe => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.onclick = (e) => { e.preventDefault(); selectPipe(pipe); };

                const decisionBadge = pipe.decision === 'ACCEPT' ?
                    '<span class="badge bg-success">ACCEPT</span>' :
                    pipe.decision === 'REJECT' ?
                    '<span class="badge bg-danger">REJECT</span>' :
                    '<span class="badge bg-secondary">' + (pipe.decision || 'N/A') + '</span>';

                const customerInfo = pipe.customer ? `<br><small class="text-info"><i class="bi bi-person"></i> ${pipe.customer}</small>` : '';
                const orderInfo = pipe.order_number ? `<span class="badge bg-light text-dark ms-1">${pipe.order_number}</span>` : '';

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${pipe.no_code}</strong> ${orderInfo}
                            <br><small class="text-muted">DN${pipe.diameter} | ${pipe.pipe_code || pipe.ladle_id || 'N/A'}</small>
                            ${customerInfo}
                        </div>
                        ${decisionBadge}
                    </div>
                `;
                resultsDiv.appendChild(item);
            });
        });
}

function selectPipe(pipe) {
    selectedPipeId = pipe.id;

    // Update preview
    updatePreview();

    // Show pipe info with all details
    const decisionClass = pipe.decision === 'ACCEPT' ? 'text-success' : pipe.decision === 'REJECT' ? 'text-danger' : 'text-secondary';
    document.getElementById('pipeInfo').innerHTML = `
        <div class="row">
            <div class="col-6">
                <h6 class="text-primary mb-2"><i class="bi bi-info-circle"></i> {{ 'معلومات الأنبوب' if session.get('lang') == 'ar' else 'Pipe Info' }}</h6>
                <table class="table table-sm table-borderless mb-0">
                    <tr><th class="text-muted" width="40%">{{ 'رقم الأنبوب' if session.get('lang') == 'ar' else 'Pipe No.' }}:</th><td><strong>${pipe.no_code}</strong></td></tr>
                    <tr><th class="text-muted">{{ 'كود الأنبوب' if session.get('lang') == 'ar' else 'Pipe Code' }}:</th><td><code>${pipe.pipe_code || 'N/A'}</code></td></tr>
                    <tr><th class="text-muted">{{ 'معرف المغرفة' if session.get('lang') == 'ar' else 'Ladle ID' }}:</th><td>${pipe.ladle_id || 'N/A'}</td></tr>
                    <tr><th class="text-muted">{{ 'القطر' if session.get('lang') == 'ar' else 'Diameter' }}:</th><td>DN${pipe.diameter}</td></tr>
                    <tr><th class="text-muted">{{ 'الصنف' if session.get('lang') == 'ar' else 'Class' }}:</th><td>${pipe.pipe_class || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-6">
                <h6 class="text-success mb-2"><i class="bi bi-briefcase"></i> {{ 'معلومات الطلب' if session.get('lang') == 'ar' else 'Order Info' }}</h6>
                <table class="table table-sm table-borderless mb-0">
                    <tr><th class="text-muted" width="40%">{{ 'كود المنتج' if session.get('lang') == 'ar' else 'Product Code' }}:</th><td><strong>${pipe.product_code || 'Auto'}</strong></td></tr>
                    <tr><th class="text-muted">{{ 'أمر الإنتاج' if session.get('lang') == 'ar' else 'Production' }}:</th><td>${pipe.order_number || 'N/A'}</td></tr>
                    <tr><th class="text-muted">{{ 'أمر البيع' if session.get('lang') == 'ar' else 'Sales Order' }}:</th><td>${pipe.sales_order || 'N/A'}</td></tr>
                    <tr><th class="text-muted">{{ 'العميل' if session.get('lang') == 'ar' else 'Customer' }}:</th><td>${pipe.customer || 'N/A'}</td></tr>
                    <tr><th class="text-muted">{{ 'القرار' if session.get('lang') == 'ar' else 'Decision' }}:</th><td class="${decisionClass}"><strong>${pipe.decision}</strong></td></tr>
                </table>
            </div>
        </div>
        ${pipe.product_description ? `<div class="mt-2 p-2 bg-light rounded"><small class="text-muted"><i class="bi bi-card-text"></i> ${pipe.product_description}</small></div>` : ''}
    `;
}

function updatePreview() {
    if (!selectedPipeId) return;

    const size = document.querySelector('input[name="stickerSize"]:checked').value;
    let url = `/stickers/generate/${selectedPipeId}?size=${size}`;

    if (size === 'custom') {
        const width = document.getElementById('customWidth').value;
        const height = document.getElementById('customHeight').value;
        url += `&width=${width}&height=${height}`;
    }

    document.getElementById('stickerPreview').src = url;
    document.getElementById('previewPlaceholder').style.display = 'none';
    document.getElementById('previewContainer').style.display = 'block';
    document.getElementById('previewActions').style.display = 'block';
}

function downloadSticker() {
    if (!selectedPipeId) return;

    const size = document.querySelector('input[name="stickerSize"]:checked').value;
    let url = `/stickers/download/${selectedPipeId}?size=${size}`;

    if (size === 'custom') {
        const width = document.getElementById('customWidth').value;
        const height = document.getElementById('customHeight').value;
        url += `&width=${width}&height=${height}`;
    }

    window.location.href = url;
}

function printSticker() {
    const img = document.getElementById('stickerPreview');
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>GCP Pipe Sticker</title>
            <style>
                @page {
                    size: auto;
                    margin: 5mm;
                }
                body {
                    margin: 0;
                    padding: 10px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 100vh;
                }
                img {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #ccc;
                }
                @media print {
                    body { padding: 0; }
                    img { border: none; }
                }
            </style>
        </head>
        <body>
            <img src="${img.src}" alt="GCP Pipe Sticker">
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        window.close();
                    }, 500);
                }
            <\/script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
</script>
{% endblock %}
