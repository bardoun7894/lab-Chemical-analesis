{% extends 'base.html' %}

{% block title %}{{ 'المساعد الذكي' if current_locale == 'ar' else 'AI Assistant' }}{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: calc(100vh - 250px);
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.message {
    max-width: 80%;
    margin-bottom: 1rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-user {
    margin-{{ 'right' if current_locale == 'ar' else 'left' }}: auto;
}

.message-assistant {
    margin-{{ 'left' if current_locale == 'ar' else 'right' }}: auto;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 15px;
    word-wrap: break-word;
}

.message-user .message-content {
    background: linear-gradient(135deg, #0d6efd, #0dcaf0);
    color: white;
    border-bottom-{{ 'left' if current_locale == 'ar' else 'right' }}-radius: 5px;
}

.message-assistant .message-content {
    background: white;
    border: 1px solid #dee2e6;
    border-bottom-{{ 'right' if current_locale == 'ar' else 'left' }}-radius: 5px;
}

.message-time {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.chat-input-area {
    padding: 1rem;
    background: white;
    border-top: 1px solid #dee2e6;
    border-radius: 0 0 10px 10px;
}

.suggestions-area {
    padding: 0.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.suggestion-btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    transition: all 0.2s;
}

.suggestion-btn:hover {
    transform: scale(1.05);
}

.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 0.5rem;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) { animation-delay: 0s; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

.welcome-message {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.welcome-icon {
    font-size: 4rem;
    color: #0d6efd;
    margin-bottom: 1rem;
}

/* Markdown styling */
.message-content pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
}

.message-content code {
    background: rgba(0,0,0,0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: monospace;
}

.message-content ul, .message-content ol {
    padding-{{ 'right' if current_locale == 'ar' else 'left' }}: 1.5rem;
    margin: 0.5rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>
                <i class="bi bi-robot text-primary"></i>
                {{ 'المساعد الذكي' if current_locale == 'ar' else 'AI Assistant' }}
            </h2>
            <p class="text-muted mb-0">
                {{ 'اسألني أي شيء عن نظام التحليل الكيميائي' if current_locale == 'ar' else 'Ask me anything about the chemical analysis system' }}
            </p>
        </div>
        <button class="btn btn-outline-secondary" onclick="clearChat()">
            <i class="bi bi-trash"></i>
            {{ 'مسح المحادثة' if current_locale == 'ar' else 'Clear Chat' }}
        </button>
    </div>

    <!-- Chat Container -->
    <div class="card border-0 shadow">
        <div class="chat-container">
            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">
                        <i class="bi bi-robot"></i>
                    </div>
                    <h4>{{ 'مرحباً!' if current_locale == 'ar' else 'Hello!' }}</h4>
                    <p>{{ 'أنا مساعدك الذكي لنظام تحليل المعمل الكيميائي. يمكنني مساعدتك في:' if current_locale == 'ar' else 'I am your AI assistant for the chemical lab analysis system. I can help you with:' }}</p>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success"></i> {{ 'فهم نتائج التحليل الكيميائي' if current_locale == 'ar' else 'Understanding chemical analysis results' }}</li>
                        <li><i class="bi bi-check-circle text-success"></i> {{ 'شرح معايير القبول والرفض' if current_locale == 'ar' else 'Explaining acceptance criteria' }}</li>
                        <li><i class="bi bi-check-circle text-success"></i> {{ 'الإجابة على أسئلة الجودة' if current_locale == 'ar' else 'Answering quality questions' }}</li>
                        <li><i class="bi bi-check-circle text-success"></i> {{ 'المساعدة في استخدام النظام' if current_locale == 'ar' else 'Helping with system usage' }}</li>
                    </ul>
                </div>
            </div>

            <!-- Suggestions -->
            <div class="suggestions-area" id="suggestionsArea">
                <span class="text-muted small">{{ 'اقتراحات:' if current_locale == 'ar' else 'Suggestions:' }}</span>
            </div>

            <!-- Input Area -->
            <div class="chat-input-area">
                <form id="chatForm" onsubmit="sendMessage(event)">
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="messageInput"
                               placeholder="{{ 'اكتب رسالتك هنا...' if current_locale == 'ar' else 'Type your message here...' }}"
                               autocomplete="off">
                        <button class="btn btn-primary" type="submit" id="sendBtn">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const welcomeMessage = document.getElementById('welcomeMessage');
const suggestionsArea = document.getElementById('suggestionsArea');
const isRTL = document.documentElement.dir === 'rtl';

let conversationHistory = [];
let isStreaming = false;

// Load suggestions
async function loadSuggestions() {
    try {
        const response = await fetch('{{ url_for("chatbot.get_suggestions") }}');
        const data = await response.json();

        if (data.suggestions) {
            const locale = '{{ current_locale }}';
            data.suggestions.forEach(suggestion => {
                const text = locale === 'ar' ? suggestion.text_ar : suggestion.text_en;
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary suggestion-btn';
                btn.textContent = text;
                btn.onclick = () => {
                    messageInput.value = text;
                    sendMessage(new Event('submit'));
                };
                suggestionsArea.appendChild(btn);
            });
        }
    } catch (error) {
        console.error('Failed to load suggestions:', error);
    }
}

// Add message to chat
function addMessage(content, isUser = false) {
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = isUser ? escapeHtml(content) : formatMarkdown(content);

    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date().toLocaleTimeString('{{ current_locale }}', { hour: '2-digit', minute: '2-digit' });

    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;

    return contentDiv;
}

// Add typing indicator
function addTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'message message-assistant';
    indicator.id = 'typingIndicator';
    indicator.innerHTML = `
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    chatMessages.appendChild(indicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Remove typing indicator
function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format markdown (basic)
function formatMarkdown(text) {
    // Code blocks
    text = text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    // Inline code
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Line breaks
    text = text.replace(/\n/g, '<br>');
    // Lists
    text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

    return text;
}

// Send message
async function sendMessage(event) {
    event.preventDefault();

    const message = messageInput.value.trim();
    if (!message || isStreaming) return;

    // Add user message
    addMessage(message, true);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input
    messageInput.value = '';

    // Hide suggestions after first message
    suggestionsArea.style.display = 'none';

    // Show typing indicator
    addTypingIndicator();
    isStreaming = true;
    sendBtn.disabled = true;

    try {
        // Use streaming
        const response = await fetch('{{ url_for("chatbot.stream_message") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                history: conversationHistory.slice(-10)
            })
        });

        removeTypingIndicator();

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        // Create message element for streaming
        const contentDiv = addMessage('', false);
        let fullResponse = '';

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.chunk) {
                            fullResponse += data.chunk;
                            contentDiv.innerHTML = formatMarkdown(fullResponse);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        } else if (data.error) {
                            contentDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle"></i> ${data.error}</span>`;
                        }
                    } catch (e) {
                        // Ignore parse errors
                    }
                }
            }
        }

        // Add to history
        if (fullResponse) {
            conversationHistory.push({ role: 'assistant', content: fullResponse });
        }

    } catch (error) {
        removeTypingIndicator();
        addMessage(`{{ 'حدث خطأ: ' if current_locale == 'ar' else 'Error: ' }}${error.message}`, false);
    }

    isStreaming = false;
    sendBtn.disabled = false;
    messageInput.focus();
}

// Clear chat
function clearChat() {
    conversationHistory = [];
    chatMessages.innerHTML = '';

    // Show welcome message again
    chatMessages.innerHTML = `
        <div class="welcome-message" id="welcomeMessage">
            <div class="welcome-icon">
                <i class="bi bi-robot"></i>
            </div>
            <h4>{{ 'مرحباً!' if current_locale == 'ar' else 'Hello!' }}</h4>
            <p>{{ 'أنا مساعدك الذكي لنظام تحليل المعمل الكيميائي.' if current_locale == 'ar' else 'I am your AI assistant for the chemical lab analysis system.' }}</p>
        </div>
    `;

    // Show suggestions
    suggestionsArea.style.display = 'flex';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadSuggestions();
    messageInput.focus();
});
</script>
{% endblock %}
