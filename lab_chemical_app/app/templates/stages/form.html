{% extends 'base.html' %}

{% block title %}{{ 'Edit' if pipe else 'Register' }} Pipe{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="bi bi-diagram-3"></i>
                {% if pipe %}
                {{ 'تعديل الأنبوب' if current_locale == 'ar' else 'Edit Pipe' }}: {{ pipe.no_code }}
                {% else %}
                {{ 'تسجيل أنبوب جديد' if current_locale == 'ar' else 'Register New Pipe' }}
                {% endif %}
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('stages.list') }}">Pipes</a></li>
                    <li class="breadcrumb-item active">{{ 'Edit' if pipe else 'Register' }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row">
            <!-- Left Column - Basic Info -->
            <div class="col-lg-6">
                <!-- Production Order Selection -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check"></i>
                            {{ 'أمر الإنتاج' if current_locale == 'ar' else 'Production Order' }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">{{ 'ربط بأمر إنتاج' if current_locale == 'ar' else 'Link to Production Order' }}</label>
                            <select name="production_order_id" class="form-select" id="productionOrderSelect">
                                <option value="">-- {{ 'بدون أمر إنتاج' if current_locale == 'ar' else 'No Production Order' }} --</option>
                                {% for order in production_orders %}
                                {% set order_ladles = order.chemical_analyses.all() %}
                                <option value="{{ order.id }}"
                                    {{ 'selected' if (pipe and pipe.production_order_id == order.id) or (selected_order_id == order.id) }}
                                    data-diameter="{{ order.diameter }}"
                                    data-type="{{ order.pipe_class }}"
                                    data-ladles="{{ order_ladles|map(attribute='ladle_id')|list|join(',') }}">
                                    {{ order.order_number }} - {{ order.customer_name or 'No Customer' }}
                                    ({{ order.produced_quantity }}/{{ order.target_quantity }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                {{ 'اختر أمر الإنتاج لربط الأنبوب به' if current_locale == 'ar' else 'Select a production order to link this pipe to' }}
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            {{ 'معلومات الأنبوب' if current_locale == 'ar' else 'Pipe Information' }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ 'كود الأنبوب' if current_locale == 'ar' else 'No. Code' }} *</label>
                                <input type="text" name="no_code" id="noCodeInput" class="form-control" required
                                       placeholder="N8739" value="{{ pipe.no_code if pipe else '' }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">{{ 'ترتيب الأنبوب' if current_locale == 'ar' else 'Pipe Order' }}</label>
                                <input type="number" name="arrange_pipe" class="form-control" id="pipeOrderInput"
                                       min="1" max="20" placeholder="1-20"
                                       value="{{ pipe.arrange_pipe if pipe else 1 }}">
                                <small class="text-muted">{{ '1-20' }}</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">{{ 'معرف المغرفة' if current_locale == 'ar' else 'Ladle ID' }}</label>
                                <select name="ladle_id" class="form-select" id="ladleIdSelect">
                                    <option value="">-- {{ 'اختر معرف المغرفة' if current_locale == 'ar' else 'Select Ladle ID' }} --</option>
                                    {% for ladle in latest_ladles %}
                                    <option value="{{ ladle.ladle_id }}"
                                            data-decision="{{ ladle.decision }}"
                                            {{ 'selected' if pipe and pipe.ladle_id == ladle.ladle_id }}>
                                        {{ ladle.ladle_id }} - {{ ladle.decision or 'N/A' }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">{{ 'آخر 4 تحليلات كيميائية' if current_locale == 'ar' else "Latest 4 chemical analyses" }}</small>
                                <div id="ladleInfo" class="mt-1" style="display: none;">
                                    <span class="badge" id="ladleDecision"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'القطر' if current_locale == 'ar' else 'Diameter (DN)' }} *</label>
                                <select name="diameter" class="form-select" required>
                                    <option value="">-- {{ 'اختر' if current_locale == 'ar' else 'Select' }} --</option>
                                    <option value="300" {{ 'selected' if pipe and pipe.diameter == 300 }}>DN300</option>
                                    <option value="400" {{ 'selected' if pipe and pipe.diameter == 400 }}>DN400</option>
                                    <option value="500" {{ 'selected' if pipe and pipe.diameter == 500 }}>DN500</option>
                                    <option value="600" {{ 'selected' if pipe and pipe.diameter == 600 }}>DN600</option>
                                    <option value="700" {{ 'selected' if pipe and pipe.diameter == 700 }}>DN700</option>
                                    <option value="800" {{ 'selected' if pipe and pipe.diameter == 800 }}>DN800</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الصنف' if current_locale == 'ar' else 'Class' }}</label>
                                <select name="pipe_class" class="form-select">
                                    <option value="">-- {{ 'اختر' if current_locale == 'ar' else 'Select' }} --</option>
                                    <option value="K9" {{ 'selected' if pipe and pipe.pipe_class == 'K9' }}>K9</option>
                                    <option value="C25" {{ 'selected' if pipe and pipe.pipe_class == 'C25' }}>C25</option>
                                    <option value="C40" {{ 'selected' if pipe and pipe.pipe_class == 'C40' }}>C40</option>
                                    <option value="Fittings" {{ 'selected' if pipe and pipe.pipe_class == 'Fittings' }}>Fittings</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'تاريخ الإنتاج' if current_locale == 'ar' else 'Production Date' }} *</label>
                                <input type="date" name="production_date" class="form-control" required
                                       value="{{ pipe.production_date if pipe else today }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الوردية' if current_locale == 'ar' else 'Shift' }}</label>
                                <select name="shift" class="form-select">
                                    <option value="">-- {{ 'اختر' if current_locale == 'ar' else 'Select' }} --</option>
                                    <option value="1" {{ 'selected' if pipe and pipe.shift == 1 }}>1 - Morning</option>
                                    <option value="2" {{ 'selected' if pipe and pipe.shift == 2 }}>2 - Afternoon</option>
                                    <option value="3" {{ 'selected' if pipe and pipe.shift == 3 }}>3 - Night</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الوزن الفعلي (كجم)' if current_locale == 'ar' else 'Actual Weight (kg)' }}</label>
                                <input type="number" name="actual_weight" class="form-control"
                                       step="0.1" min="0" value="{{ pipe.actual_weight if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'السُمك' if current_locale == 'ar' else 'Thickness' }}</label>
                                <input type="number" name="thickness" class="form-control"
                                       step="0.001" min="0" value="{{ pipe.thickness if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'رقم القالب' if current_locale == 'ar' else 'Mold Number' }}</label>
                                <select name="mold_number" class="form-select">
                                    <option value="">-- {{ 'اختر' if current_locale == 'ar' else 'Select' }} --</option>
                                    <option value="1462" {{ 'selected' if pipe and pipe.mold_number == '1462' }}>1462</option>
                                    <option value="1465" {{ 'selected' if pipe and pipe.mold_number == '1465' }}>1465</option>
                                    <option value="1467" {{ 'selected' if pipe and pipe.mold_number == '1467' }}>1467</option>
                                    <option value="1468" {{ 'selected' if pipe and pipe.mold_number == '1468' }}>1468</option>
                                    <option value="H157" {{ 'selected' if pipe and pipe.mold_number == 'H157' }}>H157</option>
                                    <option value="T157" {{ 'selected' if pipe and pipe.mold_number == 'T157' }}>T157</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Additional Info -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i>
                            {{ 'تفاصيل إضافية' if current_locale == 'ar' else 'Additional Details' }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">{{ 'كود الأنبوب' if current_locale == 'ar' else 'Pipe Code' }}</label>
                            <input type="text" name="pipe_code" id="pipeCodeInput" class="form-control" readonly
                                   value="{{ pipe.pipe_code if pipe else '' }}"
                                   placeholder="{{ 'يتم توليده تلقائياً' if current_locale == 'ar' else 'Auto-generated' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ 'مهندس الوردية' if current_locale == 'ar' else 'Shift Engineer' }}</label>
                            <input type="text" name="shift_engineer" class="form-control"
                                   value="{{ pipe.shift_engineer if pipe else '' }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Production Stages - Full Width -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i>
                    {{ 'مراحل الإنتاج' if current_locale == 'ar' else 'Production Stages' }}
                </h5>
            </div>
            <div class="card-body">
                {% set stage_names = ['Melting Ladle', 'CCM', 'Annealing', 'Lab', 'Zinc', 'Cutting', 'Hydrotest', 'Cement', 'Coating', 'Finish'] %}
                {% set stage_map = {} %}
                {% if pipe %}
                    {% for stage in pipe.stages %}
                        {% set _ = stage_map.update({stage.stage_name: stage}) %}
                    {% endfor %}
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th width="9%">{{ 'المرحلة' if current_locale == 'ar' else 'Stage' }}</th>
                                <th width="10%">{{ 'الماكينة' if current_locale == 'ar' else 'Machine' }}</th>
                                <th width="12%">{{ 'القرار' if current_locale == 'ar' else 'Decision' }}</th>
                                <th width="14%">{{ 'التاريخ/الوقت/الطول' if current_locale == 'ar' else 'Date/Time/Length' }}</th>
                                <th width="12%">{{ 'نوع العيب' if current_locale == 'ar' else 'Defect Type' }}</th>
                                <th width="12%">{{ 'سبب العيب' if current_locale == 'ar' else 'Defect Reason' }}</th>
                                <th width="16%">{{ 'ملاحظات' if current_locale == 'ar' else 'Notes' }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stage_name in stage_names %}
                            {% set stage = stage_map.get(stage_name) %}
                            {% set decisions = stage_decisions.get(stage_name, []) %}
                            {% set defects = stage_defects.get(stage_name, []) %}
                            {% set machines = stage_machines.get(stage_name, []) %}
                            <tr>
                                <td><strong>{{ stage_name }}</strong></td>
                                <td>
                                    {% if machines %}
                                    <select name="stage_{{ stage_name }}_machine_id" class="form-select form-select-sm">
                                        <option value="">-</option>
                                        {% for machine in machines %}
                                        <option value="{{ machine.id }}" {{ 'selected' if stage and stage.machine_id == machine.id }}>
                                            {{ machine.code }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select name="stage_{{ stage_name }}_decision" class="form-select form-select-sm">
                                        <option value="">-</option>
                                        {% for decision_en, decision_ar in decisions %}
                                        <option value="{{ decision_en }}" {{ 'selected' if stage and stage.decision == decision_en }}>
                                            {{ decision_en }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    {% if stage_name == 'Annealing' %}
                                    <!-- Date and Time for Annealing -->
                                    <div class="row g-1">
                                        <div class="col-7">
                                            <input type="date" name="stage_{{ stage_name }}_date" class="form-control form-control-sm"
                                                   value="{{ stage.stage_date if stage and stage.stage_date else '' }}"
                                                   title="{{ 'التاريخ' if current_locale == 'ar' else 'Date' }}">
                                        </div>
                                        <div class="col-5">
                                            <input type="time" name="stage_{{ stage_name }}_time" class="form-control form-control-sm"
                                                   value="{{ stage.stage_time if stage and stage.stage_time else '' }}"
                                                   title="{{ 'الوقت' if current_locale == 'ar' else 'Time' }}">
                                        </div>
                                    </div>
                                    {% elif stage_name == 'Finish' %}
                                    <!-- Length for Finish -->
                                    <div class="input-group input-group-sm">
                                        <input type="number" name="stage_{{ stage_name }}_length" class="form-control form-control-sm"
                                               step="0.01" min="0" placeholder="6.0"
                                               value="{{ stage.measurement_value if stage and stage.measurement_value else '' }}"
                                               title="{{ 'الطول' if current_locale == 'ar' else 'Length' }}">
                                        <span class="input-group-text">m</span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select name="stage_{{ stage_name }}_defect_type" class="form-select form-select-sm">
                                        <option value="">{{ 'لا يوجد' if current_locale == 'ar' else 'None' }}</option>
                                        {% for defect_en, defect_ar in defects %}
                                        <option value="{{ defect_en }}" {{ 'selected' if stage and stage.defect_type == defect_en }}>
                                            {{ defect_en }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="stage_{{ stage_name }}_defect_reason" class="form-control form-control-sm"
                                           value="{{ stage.defect_reason if stage and stage.defect_reason else '' }}"
                                           placeholder="{{ 'سبب العيب' if current_locale == 'ar' else 'Defect Reason' }}">
                                </td>
                                <td>
                                    <input type="text" name="stage_{{ stage_name }}_notes" class="form-control form-control-sm"
                                           value="{{ stage.notes if stage and stage.notes else '' }}"
                                           placeholder="{{ 'ملاحظات' if current_locale == 'ar' else 'Notes' }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info small mb-0">
                    <i class="bi bi-info-circle"></i>
                    {{ 'يمكنك تحديث قرارات كل مرحلة هنا أو من صفحة التفاصيل' if current_locale == 'ar' else 'You can update stage decisions here or from the detail page' }}
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex gap-2 justify-content-end mb-4">
            <a href="{{ url_for('stages.list') }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i>
                {{ 'إلغاء' if current_locale == 'ar' else 'Cancel' }}
            </a>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i>
                {{ 'حفظ' if current_locale == 'ar' else 'Save' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-fill diameter and type when selecting a production order
document.getElementById('productionOrderSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        const diameter = selectedOption.getAttribute('data-diameter');
        const pipeType = selectedOption.getAttribute('data-type');
        const ladles = selectedOption.getAttribute('data-ladles');

        if (diameter) {
            document.querySelector('select[name="diameter"]').value = diameter;
        }
        if (pipeType) {
            document.querySelector('select[name="pipe_class"]').value = pipeType;
        }

        // Auto-select first available ladle from the production order in the dropdown
        if (ladles) {
            const ladleList = ladles.split(',');
            const ladleSelect = document.getElementById('ladleIdSelect');

            for (let ladle of ladleList) {
                ladle = ladle.trim();
                if (ladle) {
                    // Check if this ladle exists in today's dropdown
                    for (let option of ladleSelect.options) {
                        if (option.value === ladle) {
                            ladleSelect.value = ladle;
                            ladleSelect.dispatchEvent(new Event('change'));
                            break;
                        }
                    }
                    break;
                }
            }
        }
    }
});

// Show chemical analysis decision when ladle is selected
document.getElementById('ladleIdSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const ladleInfo = document.getElementById('ladleInfo');
    const ladleDecision = document.getElementById('ladleDecision');

    if (selectedOption.value) {
        const decision = selectedOption.getAttribute('data-decision');
        ladleInfo.style.display = 'block';
        ladleDecision.textContent = decision || 'No Decision';

        // Set badge color based on decision
        ladleDecision.className = 'badge ';
        if (decision === 'فحص أخيرة فقط') {
            ladleDecision.className += 'bg-success';
        } else if (decision === 'تالف') {
            ladleDecision.className += 'bg-danger';
        } else if (decision === 'فحص الشحنة 100%') {
            ladleDecision.className += 'bg-warning text-dark';
        } else if (decision === 'فحص أولى وأخيرة') {
            ladleDecision.className += 'bg-info';
        } else {
            ladleDecision.className += 'bg-secondary';
        }
    } else {
        ladleInfo.style.display = 'none';
    }
});

// Trigger on page load if ladle already selected
if (document.getElementById('ladleIdSelect').value) {
    document.getElementById('ladleIdSelect').dispatchEvent(new Event('change'));
}

// Auto-fill ladle on page load if production order is pre-selected
const productionOrderSelect = document.getElementById('productionOrderSelect');
if (productionOrderSelect.value && !document.getElementById('ladleIdSelect').value) {
    productionOrderSelect.dispatchEvent(new Event('change'));
}

// Auto-generate Pipe Code based on: no_code + pipe_order + ladle_id
function generatePipeCode() {
    const noCode = document.getElementById('noCodeInput').value.trim();
    const pipeOrder = document.getElementById('pipeOrderInput').value.trim();
    const ladleId = document.getElementById('ladleIdSelect').value.trim();

    // Generate pipe code: {no_code}-{pipe_order}-{ladle_id}
    const parts = [];
    if (noCode) parts.push(noCode);
    if (pipeOrder) parts.push(pipeOrder);
    if (ladleId) parts.push(ladleId);

    const pipeCode = parts.join('-');
    document.getElementById('pipeCodeInput').value = pipeCode;
}

// Add event listeners to auto-generate pipe code
document.getElementById('noCodeInput').addEventListener('input', generatePipeCode);
document.getElementById('pipeOrderInput').addEventListener('input', generatePipeCode);
document.getElementById('ladleIdSelect').addEventListener('change', generatePipeCode);

// Generate on page load if values exist
generatePipeCode();
</script>
{% endblock %}
