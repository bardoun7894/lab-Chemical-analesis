{% extends 'base.html' %}

{% block title %}{{ 'Edit' if pipe else 'Register' }} Pipe{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="bi bi-diagram-3"></i>
                {% if pipe %}
                {{ 'تعديل الأنبوب' if session.get('lang') == 'ar' else 'Edit Pipe' }}: {{ pipe.no_code }}
                {% else %}
                {{ 'تسجيل أنبوب جديد' if session.get('lang') == 'ar' else 'Register New Pipe' }}
                {% endif %}
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('stages.index') }}">Pipes</a></li>
                    <li class="breadcrumb-item active">{{ 'Edit' if pipe else 'Register' }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row">
            <!-- Left Column - Basic Info -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            {{ 'معلومات الأنبوب' if session.get('lang') == 'ar' else 'Pipe Information' }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">{{ 'كود الأنبوب' if session.get('lang') == 'ar' else 'No. Code' }} *</label>
                                <input type="text" name="no_code" class="form-control" required
                                       placeholder="N8739" value="{{ pipe.no_code if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'معرف المغرفة' if session.get('lang') == 'ar' else 'Ladle ID' }}</label>
                                <input type="text" name="ladle_id" class="form-control"
                                       placeholder="4713012025" value="{{ pipe.ladle_id if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'القطر' if session.get('lang') == 'ar' else 'Diameter (DN)' }} *</label>
                                <select name="diameter" class="form-select" required>
                                    <option value="">-- {{ 'اختر' if session.get('lang') == 'ar' else 'Select' }} --</option>
                                    <option value="300" {{ 'selected' if pipe and pipe.diameter == 300 }}>DN300</option>
                                    <option value="400" {{ 'selected' if pipe and pipe.diameter == 400 }}>DN400</option>
                                    <option value="500" {{ 'selected' if pipe and pipe.diameter == 500 }}>DN500</option>
                                    <option value="600" {{ 'selected' if pipe and pipe.diameter == 600 }}>DN600</option>
                                    <option value="700" {{ 'selected' if pipe and pipe.diameter == 700 }}>DN700</option>
                                    <option value="800" {{ 'selected' if pipe and pipe.diameter == 800 }}>DN800</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'النوع' if session.get('lang') == 'ar' else 'Type' }}</label>
                                <select name="pipe_type" class="form-select">
                                    <option value="">-- {{ 'اختر' if session.get('lang') == 'ar' else 'Select' }} --</option>
                                    <option value="K9" {{ 'selected' if pipe and pipe.pipe_type == 'K9' }}>K9</option>
                                    <option value="C25" {{ 'selected' if pipe and pipe.pipe_type == 'C25' }}>C25</option>
                                    <option value="C40" {{ 'selected' if pipe and pipe.pipe_type == 'C40' }}>C40</option>
                                    <option value="Fittings" {{ 'selected' if pipe and pipe.pipe_type == 'Fittings' }}>Fittings</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'تاريخ الإنتاج' if session.get('lang') == 'ar' else 'Production Date' }} *</label>
                                <input type="date" name="production_date" class="form-control" required
                                       value="{{ pipe.production_date if pipe else today }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الوردية' if session.get('lang') == 'ar' else 'Shift' }}</label>
                                <select name="shift" class="form-select">
                                    <option value="">-- {{ 'اختر' if session.get('lang') == 'ar' else 'Select' }} --</option>
                                    <option value="1" {{ 'selected' if pipe and pipe.shift == 1 }}>1 - Morning</option>
                                    <option value="2" {{ 'selected' if pipe and pipe.shift == 2 }}>2 - Afternoon</option>
                                    <option value="3" {{ 'selected' if pipe and pipe.shift == 3 }}>3 - Night</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الماكينة' if session.get('lang') == 'ar' else 'Machine' }}</label>
                                <select name="machine_id" class="form-select">
                                    <option value="">-- {{ 'اختر' if session.get('lang') == 'ar' else 'Select' }} --</option>
                                    {% for machine in machines %}
                                    <option value="{{ machine.id }}"
                                        {{ 'selected' if pipe and pipe.machine_id == machine.id }}>
                                        {{ machine.machine_code }} ({{ machine.stage }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'الوزن الفعلي (كجم)' if session.get('lang') == 'ar' else 'Actual Weight (kg)' }}</label>
                                <input type="number" name="actual_weight" class="form-control"
                                       step="0.1" min="0" value="{{ pipe.actual_weight if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'السُمك' if session.get('lang') == 'ar' else 'Thickness' }}</label>
                                <input type="number" name="thickness" class="form-control"
                                       step="0.001" min="0" value="{{ pipe.thickness if pipe else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'رقم القالب' if session.get('lang') == 'ar' else 'Mold Number' }}</label>
                                <input type="text" name="mold_number" class="form-control"
                                       value="{{ pipe.mold_number if pipe else '' }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Production Stages -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check"></i>
                            {{ 'مراحل الإنتاج' if session.get('lang') == 'ar' else 'Production Stages' }}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% set stage_names = ['CCM', 'Annealing', 'Zinc', 'Cutting', 'Hydrotest', 'Cement', 'Coating', 'Finish'] %}
                        {% set stage_map = {} %}
                        {% if pipe %}
                            {% for stage in pipe.stages %}
                                {% set _ = stage_map.update({stage.stage_name: stage}) %}
                            {% endfor %}
                        {% endif %}

                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>{{ 'المرحلة' if session.get('lang') == 'ar' else 'Stage' }}</th>
                                        <th>{{ 'القرار' if session.get('lang') == 'ar' else 'Decision' }}</th>
                                        <th>{{ 'عيب' if session.get('lang') == 'ar' else 'Defect' }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stage_name in stage_names %}
                                    {% set stage = stage_map.get(stage_name) %}
                                    <tr>
                                        <td><strong>{{ stage_name }}</strong></td>
                                        <td>
                                            <select name="stage_{{ stage_name }}_decision" class="form-select form-select-sm">
                                                <option value="">-</option>
                                                <option value="ACCEPT" {{ 'selected' if stage and stage.decision == 'ACCEPT' }}>Accept</option>
                                                <option value="REJECT" {{ 'selected' if stage and stage.decision == 'REJECT' }}>Reject</option>
                                                <option value="HOLD" {{ 'selected' if stage and stage.decision == 'HOLD' }}>Hold</option>
                                                <option value="REWORK" {{ 'selected' if stage and stage.decision == 'REWORK' }}>Rework</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="checkbox" name="stage_{{ stage_name }}_defect"
                                                   class="form-check-input" {{ 'checked' if stage and stage.has_defect }}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info small mb-0">
                            <i class="bi bi-info-circle"></i>
                            {{ 'يمكنك تحديث قرارات كل مرحلة هنا أو من صفحة التفاصيل' if session.get('lang') == 'ar' else 'You can update stage decisions here or from the detail page' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex gap-2 justify-content-end mb-4">
            <a href="{{ url_for('stages.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i>
                {{ 'إلغاء' if session.get('lang') == 'ar' else 'Cancel' }}
            </a>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i>
                {{ 'حفظ' if session.get('lang') == 'ar' else 'Save' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}
